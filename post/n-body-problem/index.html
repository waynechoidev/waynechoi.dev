<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/baa01199c04a1a03.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/602feae4669a507e.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-410015a84325bd9d.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-33f88dcb8cab817d.js" async="" crossorigin=""></script><script src="/_next/static/chunks/472-c5427e31248623a0.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-998ad79e34130139.js" async="" crossorigin=""></script><script src="/_next/static/chunks/326-6784f49434136418.js" async=""></script><script src="/_next/static/chunks/app/layout-21c5cbba278c1661.js" async=""></script><script src="/_next/static/chunks/691-d72542b099e0bc41.js" async=""></script><script src="/_next/static/chunks/app/post/%5Bslug%5D/page-c6220fba5b22e67b.js" async=""></script><title>WayneChoi.Dev</title><meta name="description" content="Wayne Choi blog"/><link rel="icon" href="/favicon.ico"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body class="mx-auto my-0"><nav class="max-w-default mx-auto px-5 py-3"><div class="flex justify-end"><a href="/about/"><span class="hover:font-bold pl-3 text-lg font-normal">About</span></a><a href="/posts/"><span class="hover:font-bold pl-3 text-lg font-normal">Posts</span></a></div></nav><header><div class="h-32 relative" id="sky"><canvas class="w-full h-full"></canvas><div class="absolute top-0 inset-x-auto w-full "><div class="w-full max-w-default mx-auto"><h1 class="text-4xl font-semibold p-5 pt-0"><a class="text-blue-800" href="/">WayneChoi.dev</a></h1></div></div></div></header><div class="max-w-default mx-auto p-5"><div><a class="text-gray-600 text-md pl-1 hover:font-bold" href="/posts/graphics/">GRAPHICS</a><h1>N-body problem</h1><p class="text-gray-400 text-sm m-0 mt-1">April 29, 2024</p><div class="mt-1"><div class="whitespace-nowrap overflow-x-auto pb-3"><a class="mr-2 text-gray-500 hover:font-bold" href="/tag/toyproject/">#toyproject</a><a class="mr-2 text-gray-500 hover:font-bold" href="/tag/webgpu/">#webgpu</a><a class="mr-2 text-gray-500 hover:font-bold" href="/tag/particles/">#particles</a><a class="mr-2 text-gray-500 hover:font-bold" href="/tag/collision/">#collision</a></div></div><div class="mt-8"><div></div></div><div><div></div></div></div></div><footer class="h-40 flex justify-center items-end"><p class="text-gray-500 text-sm">(C) 2021. Wayne Choi. All rights reserved.</p></footer><script src="/_next/static/chunks/webpack-410015a84325bd9d.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/baa01199c04a1a03.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/css/602feae4669a507e.css\",\"style\",{\"crossOrigin\":\"\"}]\n"])</script><script>self.__next_f.push([1,"4:I[3728,[],\"\"]\n6:I[9928,[],\"\"]\n7:I[9194,[\"326\",\"static/chunks/326-6784f49434136418.js\",\"185\",\"static/chunks/app/layout-21c5cbba278c1661.js\"],\"\"]\n8:I[5629,[\"326\",\"static/chunks/326-6784f49434136418.js\",\"185\",\"static/chunks/app/layout-21c5cbba278c1661.js\"],\"\"]\n9:I[6954,[],\"\"]\na:I[7264,[],\"\"]\nc:I[8326,[\"326\",\"static/chunks/326-6784f49434136418.js\",\"691\",\"static/chunks/691-d72542b099e0bc41.js\",\"605\",\"static/chunks/app/post/%5Bslug%5D/page-c6220fba5b22e67b.js\"],\"\"]\nd:I[7708,[\"326\",\"static/chunks/326-6784f494341"])</script><script>self.__next_f.push([1,"36418.js\",\"691\",\"static/chunks/691-d72542b099e0bc41.js\",\"605\",\"static/chunks/app/post/%5Bslug%5D/page-c6220fba5b22e67b.js\"],\"\"]\nf:I[5631,[\"326\",\"static/chunks/326-6784f49434136418.js\",\"691\",\"static/chunks/691-d72542b099e0bc41.js\",\"605\",\"static/chunks/app/post/%5Bslug%5D/page-c6220fba5b22e67b.js\"],\"\"]\ne:Te7b,"])</script><script>self.__next_f.push([1,"\n\u003cimg src=\"/img/n-body-problem.jpg\" class=\"post-pic\"\u003e\n\n[Sample](https://waynechoidev.github.io/n-body-problem/) / [Repository](https://github.com/waynechoidev/n-body-problem/)\n\nRecently, I heard that the Netflix series \"3 Body Problem\" is popular, so I decided to try implementing an N-body simulation using WebGPU.\n\nI found that the largest observed multiple star system to date consists of 7 stars, so I constructed the simulation as a 7-body problem. Since I compute accelerations for all objects considering their distances and masses using a compute shader, I could increase the number of bodies as long as the GPU performance allows it, but I didn't increase it further because it didn't look aesthetically pleasing with too many bodies.\n\nI followed Newton's equations as is but adjusted the gravitational constant to fit the screen size and speed. Collisions are not implemented separately, so stars can pass through each other.\n\nInitially, there was an issue where position coordinates became NaN on Android mobile devices, which was due to floating-point precision. To use the f16 data type in WebGPU, a separate extension is required, which is not yet supported in Chrome for Android. So, for mobile devices, f32 data type needs to be used, but due to hardware limitations, computations are done with precision even lower than f16.\n\nWhen the distance between objects became excessively close, on desktops, computations were precise enough to avoid such issues. However, on mobile devices, when that distance was recognized as 0, it caused problems in the formulas of the law of gravitation where the distance squared is divided and in normalizing distance vectors to obtain direction vectors, resulting in NaN values. So, I resolved this by clamping the distance values to small decimals recognizable on mobile devices to prevent them from reaching 0.\n\nBelow is the compute shader code for calculating the positions of objects.\n\n```js\nstruct Vertex {\n  @location(0) position: vec3f,\n  @location(1) velocity: vec3f,\n  @location(2) color: vec3f,\n  @location(3) texCoord: vec2f,\n  @location(4) radius: f32,\n  @location(5) mass: f32,\n};\n\n@group(0) @binding(0) var\u003cstorage, read_write\u003e objects: array\u003cVertex\u003e;\n@group(0) @binding(1) var\u003cuniform\u003e numOfObject: u32;\n@group(0) @binding(2) var\u003cuniform\u003e delta: f32;\n\nconst MIN_DISTANCE: f32 = 0.0001;\n\n@compute @workgroup_size(256) fn computeSomething(\n    @builtin(global_invocation_id) global_invocation_id : vec3u,\n) {\n    let index = global_invocation_id.x;\n    var body : Vertex = objects[index];\n    var acceleration = vec3f(0.0, 0.0, 0.0);\n\n    for (var i = 0u; i \u003c numOfObject; i++) {\n        if (i != index) {\n            let other : Vertex = objects[i];\n            let distance_vec = other.position - body.position;\n            var distance = length(distance_vec);\n            if (distance \u003c MIN_DISTANCE) {\n                distance = MIN_DISTANCE;\n            }\n            let force = (0.0006673 * body.mass * other.mass) / distance * distance;\n            var direction = vec3(0.0, 0.0, 0.0);\n            if (distance \u003e MIN_DISTANCE) {\n                direction = normalize(distance_vec);\n            }\n            acceleration += vec3(direction * force / body.mass);\n        }\n    }\n\n    body.velocity += acceleration;\n    body.position += body.velocity * delta;\n    objects[index] = body;\n}\n```\n\nFor the graphics pipeline, I generated billboards from those positions in the compute shader, rotated them according to the camera direction, and then drew stars in the fragment shader. I referenced an [example made by \"flight404\" on ShaderToy](https://www.shadertoy.com/view/4dXGR4) for the fragment shader code but simplified it significantly.\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/baa01199c04a1a03.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"1m-WXX2klD5v2QtgzQrA-\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/n-body-problem/\",\"initialTree\":[\"\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"n-body-problem\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"n-body-problem\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L5\"],\"globalErrorComponent\":\"$6\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"mx-auto my-0\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"max-w-default mx-auto px-5 py-3\",\"children\":[\"$\",\"$L7\",null,{}]}],[\"$\",\"header\",null,{\"children\":[\"$\",\"$L8\",null,{}]}],[\"$\",\"div\",null,{\"className\":\"max-w-default mx-auto p-5\",\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[null,[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\",[\"slug\",\"n-body-problem\",\"d\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lb\",[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Lc\",null,{\"href\":\"/posts/graphics\",\"className\":\"text-gray-600 text-md pl-1 hover:font-bold\",\"children\":\"GRAPHICS\"}],[\"$\",\"h1\",null,{\"children\":\"N-body problem\"}],[\"$\",\"p\",null,{\"className\":\"text-gray-400 text-sm m-0 mt-1\",\"children\":\"April 29, 2024\"}],[\"$\",\"div\",null,{\"className\":\"mt-1\",\"children\":[\"$\",\"div\",null,{\"className\":\"whitespace-nowrap overflow-x-auto pb-3\",\"children\":[[\"$\",\"$Lc\",\"toyproject\",{\"href\":\"/tag/toyproject\",\"className\":\"mr-2 text-gray-500 hover:font-bold\",\"children\":\"#toyproject\"}],[\"$\",\"$Lc\",\"webgpu\",{\"href\":\"/tag/webgpu\",\"className\":\"mr-2 text-gray-500 hover:font-bold\",\"children\":\"#webgpu\"}],[\"$\",\"$Lc\",\"particles\",{\"href\":\"/tag/particles\",\"className\":\"mr-2 text-gray-500 hover:font-bold\",\"children\":\"#particles\"}],[\"$\",\"$Lc\",\"collision\",{\"href\":\"/tag/collision\",\"className\":\"mr-2 text-gray-500 hover:font-bold\",\"children\":\"#collision\"}]]}]}],[\"$\",\"div\",null,{\"className\":\"mt-8\",\"children\":[\"$\",\"$Ld\",null,{\"content\":\"$e\"}]}],[\"$\",\"$Lf\",null,{\"issueTerm\":\"N-body problem\"}]]}],null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"n-body-problem\\\"}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/602feae4669a507e.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]]}],null],\"segment\":[\"slug\",\"n-body-problem\",\"d\"]},\"styles\":[]}],\"segment\":\"post\"},\"styles\":[]}]}],[\"$\",\"footer\",null,{\"className\":\"h-40 flex justify-center items-end\",\"children\":[\"$\",\"p\",null,{\"className\":\"text-gray-500 text-sm\",\"children\":\"(C) 2021. Wayne Choi. All rights reserved.\"}]}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"5:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"WayneChoi.Dev\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Wayne Choi blog\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\"}]]\nb:null\n"])</script></body></html>